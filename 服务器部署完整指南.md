# 服务器部署完整指南

## 部署目标

将后端服务部署到云服务器，实现：
- ✅ 不同网络的人都可以访问
- ✅ 使用 HTTPS 安全连接
- ✅ 稳定的服务运行
- ✅ 支持多人同时使用

## 第一步：准备云服务器

### 1.1 选择云服务商

**推荐选项**：

1. **腾讯云**（推荐，与微信生态集成好）
   - 地址：https://cloud.tencent.com
   - 新用户有优惠
   - 与微信小程序集成方便

2. **阿里云**
   - 地址：https://www.aliyun.com
   - 稳定可靠
   - 价格合理

3. **其他选择**
   - 华为云、AWS、Azure 等

### 1.2 购买服务器配置建议

**最低配置**（适合测试和小规模使用）：
- CPU：1核
- 内存：2GB
- 带宽：1-3Mbps
- 系统：Ubuntu 20.04 LTS 或 CentOS 7+

**推荐配置**（适合正式使用）：
- CPU：2核
- 内存：4GB
- 带宽：3-5Mbps
- 系统：Ubuntu 20.04 LTS

### 1.3 购买域名（必需）

**要求**：
- 必须已备案（国内服务器）
- 支持 HTTPS
- 建议使用 .com 或 .cn 域名

**购买渠道**：
- 腾讯云、阿里云都可以购买
- 价格：通常 50-100元/年

## 第二步：服务器环境准备

### 2.1 连接服务器

使用 SSH 连接服务器：

```bash
ssh root@你的服务器IP
```

### 2.2 更新系统

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS
sudo yum update -y
```

### 2.3 安装 Node.js

```bash
# 使用 nvm 安装（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 16
nvm use 16
nvm alias default 16

# 验证安装
node -v
npm -v
```

### 2.4 安装 MySQL

```bash
# Ubuntu/Debian
sudo apt install mysql-server -y

# CentOS
sudo yum install mysql-server -y

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

### 2.5 安装 Nginx

```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS
sudo yum install nginx -y

# 启动 Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 2.6 安装 PM2（进程管理）

```bash
npm install -g pm2
```

## 第三步：上传代码到服务器

### 3.1 方法一：使用 Git（推荐）

#### 在服务器上安装 Git

```bash
sudo apt install git -y  # Ubuntu
# 或
sudo yum install git -y  # CentOS
```

#### 在服务器上克隆代码

```bash
cd /opt
git clone 你的代码仓库地址
# 或者直接上传代码包
```

### 3.2 方法二：使用 SCP 上传

在本地电脑执行：

```bash
# 上传整个项目
scp -r /Users/davidzhan/Desktop/重走长征路小程序 root@你的服务器IP:/opt/

# 或者只上传 server 目录
scp -r /Users/davidzhan/Desktop/重走长征路小程序/server root@你的服务器IP:/opt/longmarch-server
```

### 3.3 方法三：使用 FTP 工具

使用 FileZilla、WinSCP 等工具上传代码。

## 第四步：配置数据库

### 4.1 创建数据库

```bash
# 登录 MySQL
mysql -u root -p

# 执行初始化脚本
source /opt/重走长征路小程序/database/init.sql;
# 或者
mysql -u root -p < /opt/重走长征路小程序/database/init.sql
```

### 4.2 创建数据库用户（可选，推荐）

```sql
CREATE USER 'longmarch'@'localhost' IDENTIFIED BY '你的密码';
GRANT ALL PRIVILEGES ON longmarch.* TO 'longmarch'@'localhost';
FLUSH PRIVILEGES;
```

## 第五步：配置后端服务

### 5.1 进入服务器目录

```bash
cd /opt/重走长征路小程序/server
# 或
cd /opt/longmarch-server
```

### 5.2 安装依赖

```bash
npm install --production
```

### 5.3 配置环境变量

```bash
# 复制环境变量文件
cp .env.example .env

# 编辑环境变量
nano .env
```

**配置内容**：

```env
# 微信小程序配置
WECHAT_APPID=你的AppID
WECHAT_APPSECRET=你的AppSecret

# 数据库配置
DB_HOST=localhost
DB_USER=longmarch
DB_PASSWORD=你的数据库密码
DB_NAME=longmarch

# 服务器配置
PORT=3000
NODE_ENV=production
```

保存：`Ctrl + O`，退出：`Ctrl + X`

### 5.4 测试运行

```bash
node app.js
```

如果看到"服务器运行在端口 3000"，说明配置成功。

按 `Ctrl + C` 停止。

## 第六步：使用 PM2 启动服务

### 6.1 启动服务

```bash
cd /opt/重走长征路小程序/server
pm2 start app.js --name longmarch-server
```

### 6.2 设置开机自启

```bash
pm2 startup
pm2 save
```

### 6.3 查看状态

```bash
pm2 status
pm2 logs longmarch-server
```

## 第七步：配置 Nginx 反向代理

### 7.1 创建 Nginx 配置

```bash
sudo nano /etc/nginx/sites-available/longmarch
```

**配置内容**：

```nginx
server {
    listen 80;
    server_name 你的域名.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name 你的域名.com;

    # SSL 证书配置（稍后配置）
    # ssl_certificate /etc/letsencrypt/live/你的域名.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/你的域名.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 反向代理到 Node.js
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 7.2 启用配置

```bash
sudo ln -s /etc/nginx/sites-available/longmarch /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl reload nginx
```

## 第八步：配置 SSL 证书（HTTPS）

### 8.1 安装 Certbot

```bash
# Ubuntu
sudo apt install certbot python3-certbot-nginx -y

# CentOS
sudo yum install certbot python3-certbot-nginx -y
```

### 8.2 获取证书

```bash
sudo certbot --nginx -d 你的域名.com
```

按照提示操作：
1. 输入邮箱
2. 同意服务条款
3. 选择是否分享邮箱（可选）
4. 自动配置完成

### 8.3 自动续期

证书会自动续期，也可以手动测试：

```bash
sudo certbot renew --dry-run
```

## 第九步：配置防火墙

### 9.1 Ubuntu/Debian (UFW)

```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 9.2 CentOS (firewalld)

```bash
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 9.3 云服务器安全组

在云服务器控制台：
1. 进入"安全组"设置
2. 添加入站规则：
   - 端口 80（HTTP）
   - 端口 443（HTTPS）
   - 端口 22（SSH）

## 第十步：更新小程序配置

### 10.1 修改小程序服务器地址

打开 `miniprogram/config.js`：

```javascript
const config = {
  development: 'http://localhost:3000',
  testing: 'http://172.20.10.5:3000',
  production: 'https://你的域名.com'  // ⚠️ 修改为你的域名
}
```

### 10.2 配置微信小程序域名

1. 登录 https://mp.weixin.qq.com
2. 进入 **"开发"** → **"开发管理"** → **"开发设置"**
3. 在 **"服务器域名"** 中添加：
   - **request合法域名**：`https://你的域名.com`
   - **uploadFile合法域名**：`https://你的域名.com`
   - **downloadFile合法域名**：`https://你的域名.com`

### 10.3 重新编译小程序

在微信开发者工具中：
1. 保存 `config.js`
2. 点击"编译"
3. 测试连接

## 第十一步：测试部署

### 11.1 测试服务器连接

在浏览器访问：
```
https://你的域名.com/health
```

应该看到：
```json
{"status":"ok","message":"服务运行正常"}
```

### 11.2 测试小程序

1. 重新编译小程序
2. 用手机扫码测试
3. 测试登录、步数同步等功能

## 部署检查清单

- [ ] 服务器已购买并配置
- [ ] 域名已购买并备案
- [ ] Node.js 已安装
- [ ] MySQL 已安装并配置
- [ ] Nginx 已安装并配置
- [ ] 代码已上传到服务器
- [ ] 数据库已初始化
- [ ] 环境变量已配置
- [ ] PM2 已启动服务
- [ ] Nginx 反向代理已配置
- [ ] SSL 证书已配置
- [ ] 防火墙已配置
- [ ] 小程序域名已配置
- [ ] 小程序代码已更新

## 常见问题

### Q1: 域名备案需要多长时间？

**通常**：7-20 个工作日

**建议**：
- 提前准备备案
- 或使用已备案的域名

### Q2: 服务器选择哪个地区？

**建议**：
- 选择用户主要分布的地区
- 国内用户选择国内服务器
- 国外用户选择海外服务器

### Q3: 如何查看服务器日志？

```bash
# PM2 日志
pm2 logs longmarch-server

# Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### Q4: 如何更新代码？

```bash
# 方法1：Git 拉取
cd /opt/重走长征路小程序/server
git pull
npm install --production
pm2 restart longmarch-server

# 方法2：重新上传
# 上传新代码后
pm2 restart longmarch-server
```

## 成本估算

**服务器**：
- 最低配置：约 50-100元/月
- 推荐配置：约 100-200元/月

**域名**：
- 约 50-100元/年

**总计**：
- 初期：约 100-200元/月
- 年费：约 1200-2400元/年

## 下一步

部署完成后：
1. 测试所有功能
2. 监控服务器性能
3. 定期备份数据库
4. 准备正式发布

## 需要帮助？

如果在部署过程中遇到问题，告诉我：
- 具体在哪一步
- 错误信息是什么
- 使用的云服务商

我会继续帮你解决！
