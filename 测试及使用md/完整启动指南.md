# 完整启动指南 - 一步步照着做

## 当前状态
- ✅ Node.js 已安装（v22.7.0）
- ✅ npm 已安装（v10.8.2）
- ✅ 数据库配置已填写（.env 文件）
- ❌ Node.js 依赖库问题需要修复
- ❌ MySQL 服务需要启动
- ❌ 数据库需要初始化

---

## 第一步：修复 Node.js 依赖库问题

**选择方案一（推荐，最快）**：

打开终端，执行：

```bash
sudo mkdir -p /opt/homebrew/opt/icu4c/lib
sudo ln -sf /opt/homebrew/Cellar/icu4c@78/78.2/lib/libicui18n.78.dylib /opt/homebrew/opt/icu4c/lib/libicui18n.74.dylib
```

**输入你的 Mac 密码**（输入时不会显示，直接回车即可）

---

## 第二步：启动 MySQL 服务

在终端执行：

```bash
# 方法1：使用 Homebrew（推荐）
brew services start mysql

# 如果方法1不行，尝试方法2：
sudo /usr/local/mysql/support-files/mysql.server start

# 如果方法2也不行，尝试方法3：
sudo launchctl load -w /Library/LaunchDaemons/com.oracle.oss.mysql.mysqld.plist
```

**验证 MySQL 是否启动**：
```bash
mysql -u root -p13359413602Zqy -e "SELECT 1;" 2>&1 | head -1
```

如果看到 `1` 或者没有错误，说明 MySQL 已启动。

---

## 第三步：初始化数据库

在终端执行：

```bash
mysql -u root -p13359413602Zqy < /Users/davidzhan/Desktop/重走长征路小程序/database/init.sql
```

**或者手动方式**：

```bash
mysql -u root -p13359413602Zqy
```

然后在 MySQL 命令行中执行：
```sql
source /Users/davidzhan/Desktop/重走长征路小程序/database/init.sql;
exit;
```

**验证数据库是否创建成功**：
```bash
mysql -u root -p13359413602Zqy -e "USE longmarch; SHOW TABLES;"
```

应该看到：`users`, `steps_records`, `departments`, `user_sessions` 这些表。

---

## 第四步：启动后端服务

```bash
cd /Users/davidzhan/Desktop/重走长征路小程序/server
npm run dev
```

**应该看到类似这样的输出**：
```
服务器运行在端口 3000
环境: development
数据库连接成功
```

**保持这个终端窗口打开**（不要关闭）

---

## 第五步：测试后端接口

**新开一个终端窗口**，执行：

```bash
curl http://localhost:3000/health
```

**应该返回**：
```json
{"status":"ok","message":"服务运行正常"}
```

如果看到这个，说明后端服务运行正常！✅

---

## 第六步：配置并运行小程序

1. **打开微信开发者工具**

2. **导入项目**：
   - 项目目录：`/Users/davidzhan/Desktop/重走长征路小程序/miniprogram`
   - AppID：填写你的小程序 AppID（如果没有，先去 https://mp.weixin.qq.com 注册）

3. **修改服务器地址**：
   - 在微信开发者工具中，打开 `app.js` 文件
   - 找到这一行：
     ```javascript
     serverUrl: 'https://your-server.com',
     ```
   - 改成：
     ```javascript
     serverUrl: 'http://localhost:3000',
     ```

4. **配置开发设置**：
   - 点击右上角"详情"
   - 在"本地设置"中，勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**

5. **编译运行**：
   - 点击顶部"编译"按钮
   - 在模拟器中测试登录和功能

---

## 常见问题排查

### 问题1：`npm run dev` 还是报错 `Library not loaded`

**解决**：确保第一步的符号链接创建成功，或者使用 nvm 安装 Node.js 20（见 FIX_NODE_ISSUE.md）

### 问题2：MySQL 启动失败

**检查 MySQL 是否安装**：
```bash
which mysql
mysql --version
```

**如果没安装，安装 MySQL**：
```bash
brew install mysql
brew services start mysql
```

### 问题3：数据库连接失败

**检查密码是否正确**：
- 打开 `.env` 文件，确认 `DB_PASSWORD=13359413602Zqy` 是正确的

**测试连接**：
```bash
mysql -u root -p13359413602Zqy -e "SELECT 1;"
```

### 问题4：端口 3000 被占用

**查看占用端口的进程**：
```bash
lsof -i :3000
```

**杀死进程**（替换 PID 为实际进程号）：
```bash
kill -9 PID
```

或者修改 `.env` 文件中的 `PORT=3001`（或其他端口）

---

## 成功标志

当你完成所有步骤后，应该能够：

1. ✅ `npm run dev` 能正常启动，看到"服务器运行在端口 3000"
2. ✅ `curl http://localhost:3000/health` 返回 JSON 响应
3. ✅ 微信开发者工具能正常编译和运行小程序
4. ✅ 小程序能正常登录和显示页面

---

## 下一步

完成本地测试后，参考 `DEPLOYMENT.md` 部署到生产环境。
