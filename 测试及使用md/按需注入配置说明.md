# 按需注入配置说明

## 什么是按需注入？

按需注入是微信小程序的一个性能优化特性。在小程序启动时，默认会加载所有页面的代码，包括你还没有访问的页面。启用按需注入后，小程序只会加载当前页面需要的代码，这样可以：

- ✅ **降低启动时间**：减少代码注入耗时
- ✅ **减少内存占用**：只加载必要的代码
- ✅ **提升用户体验**：小程序启动更快

## 配置位置

我已经在 `app.json` 中添加了配置：

```json
{
  "lazyCodeLoading": "requiredComponents"
}
```

这个配置告诉小程序：
- 只注入当前访问页面所需的自定义组件和页面代码
- 未访问的页面不会被加载
- 当前页面未声明的自定义组件不会被加载

## 配置要求

- **基础库版本**：需要 2.11.1 及以上版本
- **开发者工具版本**：建议使用 1.05.2111300 及以上版本
- **基础库选择**：在开发者工具中选择 2.20.1 及以上版本

## 注意事项

### 1. 确认小程序表现正常

启用按需注入后，请务必测试所有页面和功能，确保：
- ✅ 所有页面都能正常打开
- ✅ 页面跳转正常
- ✅ 自定义组件正常显示
- ✅ 数据加载正常

### 2. 清理未使用的组件声明

在页面 JSON 配置中，如果声明了自定义组件但没有使用，建议移除：

**示例**：
```json
// pages/index/index.json
{
  "usingComponents": {
    "my-component": "/components/my-component"  // 如果页面中没有使用，应该删除
  }
}
```

### 3. 避免全局声明使用率低的组件

在 `app.json` 的 `usingComponents` 中，如果某些组件使用率很低，建议：
- 改为在具体页面中按需引入
- 或者使用「用时注入」（更高级的优化）

### 4. 插件和扩展库

- 插件包和扩展库目前**不支持**按需注入
- 如果需要插件按需加载，可以考虑将插件放在分包中，使用「分包异步化」

## 如何检查配置是否生效

1. **在开发者工具中**：
   - 打开"调试器" → "Console"
   - 查看是否有相关警告或错误

2. **性能监控**：
   - 打开"调试器" → "Performance"
   - 观察代码注入时间是否减少

3. **内存使用**：
   - 打开"调试器" → "Memory"
   - 观察内存占用是否降低

## 如果遇到问题

### 问题1：某些页面打不开

**可能原因**：页面依赖的组件没有被正确注入

**解决**：
- 检查页面 JSON 中是否正确声明了使用的组件
- 确保组件路径正确

### 问题2：组件显示异常

**可能原因**：组件代码没有被加载

**解决**：
- 检查组件是否在页面 JSON 中声明
- 确认组件文件路径正确

### 问题3：数据加载失败

**可能原因**：页面初始化代码执行时机问题

**解决**：
- 检查页面生命周期函数（onLoad、onShow等）是否正常执行
- 确保数据请求在正确的生命周期中

## 进一步优化：用时注入

如果你想要更激进的优化，可以使用「用时注入」：

1. 为自定义组件配置占位组件
2. 组件在第一次渲染前不会被注入
3. 第一次渲染时显示占位组件，然后注入真实组件

**参考文档**：https://developers.weixin.qq.com/miniprogram/dev/framework/ability/lazyload.html#%E7%94%A8%E6%97%B6%E6%B3%A8%E5%85%A5

## 当前项目状态

✅ 已启用按需注入配置
✅ 配置位置：`miniprogram/app.json`
✅ 配置项：`"lazyCodeLoading": "requiredComponents"`

## 测试建议

配置完成后，请测试：

1. **首页**：打开首页，检查是否正常显示
2. **页面跳转**：测试各个 TabBar 页面切换
3. **登录流程**：测试登录和处室选择
4. **数据加载**：测试步数同步和统计功能

如果所有功能正常，说明配置成功！🎉
